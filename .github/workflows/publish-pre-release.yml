name: Build, Test and Publish

on:
  push:
    branches:
      - main

jobs:
  publish-pre-release:
    if: |
      contains(github.event.head_commit.message, 'Merge pull request') &&
      contains(github.event.head_commit.message, 'release-v') &&
      contains(github.event.head_commit.message, 'Beta Testing')
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Set up Python 
      uses: actions/setup-python@v3
    - name: Install uv
      uses: astral-sh/setup-uv@v5
      with:
        enable-cache: true
        cache-dependency-glob: "uv.lock"
    - name: Install the project
      run: uv sync --all-extras --dev
    - name: Run Tests
      run: uv run pytest --cov=hello_world --cov-report=term-missing --cov-fail-under=80
    - name: Build the artifact in dist/
      run: uv build

    # Publish to TestPyPI
    - name: Publish to TestPyPI
      env:
        TWINE_USERNAME: __token__
        TWINE_PASSWORD: ${{ secrets.TEST_PYPI_API_TOKEN }}
      run: |
        twine upload --repository testpypi dist/*

